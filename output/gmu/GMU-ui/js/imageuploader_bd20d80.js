!function(a,t){a.ui.create("imageuploader",{_data:{container:"",instanceId:"",type:"form",fnName:"callback",fileFilter:"",onselect:function(){}},_create:function(){var t=this,e=t.widget(),i=a(t.data("container")||document.body)[0],d=t.data("instanceId"),n=t.data("type"),r=a("<div class='ui-imageuploader-wrap'><input class='ui-imageuploader-ipt' name='pic' type='file'/></div>");if("form"==n){var o=a("<iframe name='ui-imageuploader-iframe'></iframe>"),c=a("<form enctype='multipart/form-data' method='post'></form>"),p=t.data("url");
p+=(-1==p.indexOf("?")?"?":"")+"&callback="+t.data("fnName"),c.append(r).attr({target:"ui-imageuploader-iframe",action:p}),o.css({display:"none"}),r=o.concat(c)}e?(e.append(r),e.parent().length?i!==document.body&&e.appendTo(i):e.appendTo(i)):e=t.widget(a("<div></div>").append(r)).appendTo(i),e.addClass(d||"ui-imageuploader"),t.trigger("create")},_init:function(){var t=this,e=t.widget(),i=t.data("fileInput",a(".ui-imageuploader-ipt",e)),d=t.data("picthumbnail");d&&d.dataVar&&(window.picDataList=window[d.dataVar]=[]),i.on("change",function(a){t._eventHandler(a)
}),t.trigger("init")},_inputChangeHandle:function(t){var e=t.target.files[0];if(e){var i=this,d=i.data("fileFilter"),n=a.isFunction(d)?d(e):i._fileFilter(e);n&&(i.trigger("select",n),"form"==i.data("type")?i._formUploadFile():i._ajaxUploadFile(n))}},_fileFilter:function(a){var t=/[^\s]+\.(jpg|gif|png|bmp)/i;return a.name&&t.test(a.name)?a:void alert('文件"'+a.name+'"不是图片')},_ajaxUploadFile:function(t){var e=this;a.ajax({url:e.data("url"),type:"POST",data:{file:t},success:function(a){e.trigger("success",a)
},error:function(){e.trigger("failed")}})},_formUploadFile:function(){var t=this,e=a("form",t.widget()),i=t.data("fnName");window[i]=function(e){e.error_code?a.isFunction(t.data("onfailed"))?t.trigger("failed",e.info):alert("上传图片失败，请重新上传"):a.isFunction(t.data("onsuccess"))?t.trigger("success",e.info):t.data("picthumbnail")&&t.data("picthumbnail").wrap&&(t._thumbnailRender(e.info),e.info.pic_rotate=0,picDataList.push(e.info)),delete window[i]},e.get(0).submit()},_thumbnailRender:function(t){var e=this,i=e.data("picthumbnailWrap",a(e.data("picthumbnail").wrap)),d=a(new Image),n=a("<a href='javascript:;'></a>");
d.attr({src:t.pic_url,"data-id":t.pic_id,"data-rotate":0}),n.append(d),i.append(n).addClass("ui-imageuploader-thumbnail"),i.on("tap",function(a){e._eventHandler(a)})},_thumbnailEventHandle:function(t){var e=this;if("IMG"==t.target.nodeName){var i=a(t.target),d={url:i.attr("src"),id:i.attr("data-id"),deg:i.attr("data-rotate")};if(window.imageeditor)window.imageeditor.refresh(d),a(".ui-imageuploader-mask").show(),a(".ui-imageuploader-editorwrap").show();else{var n=e.data("editorMask",a("<div class='ui-imageuploader-mask'></div>")),r=a("<div class='ui-imageuploader-editorwrap'></div>"),o=e.data("editorDel",a("<a href='javascript:;'>删除</a>")),c=e.data("editorBack",a("<a href='javascript:;'>返回</a>"));
n.appendTo(document.body),r.appendTo(document.body).append(o).append(c),window.imageeditor=a.ui.imageeditor(r,{picData:d,onrotate:function(t,i){var d=a(t).attr("data-id"),n=a(e.data("picthumbnail").wrap).find("img");a.each(n,function(t,e){a(e).attr("data-id")==d&&(a(e).css("-webkit-transform","rotate("+i+"deg)"),a(e).attr("data-rotate",i))}),e._updatePicDataList(d,i)},ondelete:function(t){var i=a(t).attr("data-id"),d=a(e.data("picthumbnail").wrap).find("img");a.each(d,function(t,e){a(e).attr("data-id")==i&&a(e).parent("a").remove()
}),e._updatePicDataList(i)},onclose:function(){n.hide()}}),n.css({display:"block",width:document.body.clientWidth,height:r[0].clientHeight}),n.on("tap",function(){imageeditor.imageClose()}),o.on("tap",function(){imageeditor.imageDel()}),c.on("tap",function(){imageeditor.imageClose()}),a(window).on("resize",function(a){e._eventHandler(a)}),e.data("editorMask",n),e.data({editorMask:n,editorWrap:r})}}},_updatePicDataList:function(e,i){var d=window.picDataList;a.each(d,function(a,n){n.pic_id==e&&(i!==t?n.pic_rotate=i:d.splice(a,1))
})},_eventHandler:function(a){var t=this;switch(a.type){case"change":t._inputChangeHandle(a);break;case"click":case"tap":t._thumbnailEventHandle(a);break;case"resize":var e=t.data("editorMask");e&&e.css({display:"block",width:document.body.clientWidth,height:t.data("editorWrap")[0].clientHeight})}},destroy:function(){var t=this,e=t.data("fileInput"),i=t.data("picthumbnailWrap"),d=t.data("editorMask"),n=t.data("editorDel"),r=t.data("editorBack");e&&e.off().remove(),i&&i.off().remove(),d&&d.off().remove(),n&&n.off().remove(),r&&r.off().remove(),a(window).off("resize"),window.imageeditor&&window.imageeditor.destroy(),delete window.imageeditor,t._super()
}})}(Zepto);