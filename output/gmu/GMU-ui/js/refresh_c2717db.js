!function(e,t){e.ui.create("refresh",{_data:{container:"",pullUpText:"加载更多",pullReleaseText:"松开立即加载",loadingText:"加载中...",clickText:"点击加载更多",type:"click",direction:"up",isShow:!0,iscroll:"",speedScale:1,useTransition:!0,topOffset:0,onReady:function(){}},_myScroll:"",range:10,_isOk:!0,_create:function(){var e=this;e._createButtonUI(),e.trigger("create")},_init:function(){var t,l,a=this,i=a.widget(),r=a.data("widgetElem2"),o=i.find(".ui-refresh-pullup-icon"),n=i.find(".ui-refresh-pullup-label"),p=e.bind(a._eventHandler,a);
-1!=e.inArray(a.data("type"),["click","pullup"])&&(a.data({hotArea:i.parent().parent().get(0),refreshing:!1,elObj:{el:i,pullUpIcon:o,pullUpLabel:n}}),r&&(t=r.find(".ui-refresh-pullup-icon"),l=r.find(".ui-refresh-pullup-label"),a.data("elObj2",{el:r,pullUpIcon:t,pullUpLabel:l})),a._loaded(),i.on("touchmove",p),"pullup"==a.data("type")?(i.on("click",p),r&&r.on("click",p)):(o.hide(),n.html(a.data("clickText")),i.on("click",p),r&&(t.hide(),l.html(a.data("clickText")),r.on("click",p))),a.data("isShow")||i.hide(),a.trigger("init"))
},_createButtonUI:function(){var l,a=this,i=a.widget(),r=[],o=a.data("direction"),n=e(a.data("container")||document.body)[0];if(-1==e.inArray(a.data("direction"),["up","down","both"])&&(o="up"),r.push('<span class="ui-refresh-pullup-icon"></span>'),"pullup"==a.data("type")?r.push('<span class="ui-refresh-pullup-label">'+a.data("pullUpText")+"</span>"):"click"==a.data("type")&&r.push('<span class="ui-refresh-pullup-label">'+a.data("clickText")+"</span>"),i===t&&(i=a.widget(e('<div class="ui-refresh"></div>')),"both"==o&&(l=a.data("widgetElem2",e('<div class="ui-refresh"></div>')))),"up"==o)i.html(r.join(""));
else if("down"==o)i.html(r.join("")),e.os.ios&&i.addClass("ui-refresh-flip");else if("both"==o){if(i.length>1){var p=i;l=a.data("widgetElem2",e(p[0])),i=a.widget(e(p[1]))}i.html(r.join("")),l.html(r.join("")),e.os.ios&&l.addClass("ui-refresh-flip")}n===document.body&&i.parent().length||("up"==o?i.appendTo(n):"down"==o?i.prependTo(n):"both"==o&&(i.appendTo(n),l.prependTo(n))),!e.os.ios&&e(".ui-refresh-pullup-icon").hide(),a.data("dir",o)},_loaded:function(){var t=this,l=t.data("hotArea"),a=t.data("dir"),i=t.data("onBeforeScrollStart"),r=t.data("onScroll"),o=t.data("onScrollEnd");
"pullup"==t.data("type")?t._myScroll=new iScroll(l,{useTransition:t.data("useTransition"),speedScale:t.data("speedScale"),topOffset:t.data("topOffset"),onBeforeScrollStart:function(t){e.isFunction(i)?i.call(this,t):t.preventDefault()},onScrollMove:function(){var l=this,i=l.distY<0&&l.y<=l.maxScrollY-t.range,o=l.distY>0&&l.y>=t.range,n=l.distY<0&&l.y>l.maxScrollY-t.range,p=l.distY>0&&l.y<t.range,s=t.data("refreshing");t._isOk&&("up"==a?!s&&i?t._pullBeforeAdapter("up","pull"):s&&n&&t._pullBeforeAdapter("up","restore"):"down"==a?!s&&o?t._pullBeforeAdapter("down","pull"):s&&p&&t._pullBeforeAdapter("down","restore"):!s&&i?t._pullBeforeAdapter("pullUpBoth","pull"):s&&n?t._pullBeforeAdapter("pullUpBoth","restore"):!s&&o?t._pullBeforeAdapter("pullDownBoth","pull"):s&&p&&t._pullBeforeAdapter("pullDownBoth","restore"),e.isFunction(r)&&r.apply(l))
},onBeforeScrollEnd:function(){t.data("refreshing")&&(t._refreshLoading("pullUp"),this.options.topOffset=0,t._refreshAction("pullUp"),t.data("refreshing",!1)),e.isFunction(o)&&o.apply(this)}}):"click"==t.data("type")&&(t._myScroll=new iScroll(l,{useTransition:t.data("useTransition"),speedScale:t.data("speedScale"),topOffset:0,onBeforeScrollStart:function(t){e.isFunction(i)?i.call(this,t):t.preventDefault()},onScrollMove:function(){e.isFunction(r)&&r.apply(this)},onScrollEnd:function(){e.isFunction(o)&&o.apply(this)
}})),t.data("iscroll",t._myScroll)},_pullBeforeAdapter:function(e,t){var l=this;l._pullBeforeLoading(e,t),l.data("refreshing",!("pull"!=t))},_pullBeforeLoading:function(t,l){var a,i=this,r="pullup"==i.data("type")?"pullUp":"click",o=i._getCurObj(t);e.os.ios?("up"==t||"pullUpBoth"==t?a="ui-refresh-flip":("down"==t||"pullDownBoth"==t)&&(a="ui-refresh-flip-origin"),"pull"==l?(o.el.addClass(a),o.pullUpLabel.html(i.data("pullReleaseText"))):(o.el.removeClass(a),o.pullUpLabel.html(i.data(r+"Text")))):("pull"==l&&o.pullUpLabel.html(i.data("pullReleaseText")),"restore"==l&&o.pullUpLabel.html(i.data(r+"Text"))),"pullUpBoth"==t&&i.data("pullDirection","pullUpBoth"),"pullDownBoth"==t&&i.data("pullDirection","pullDownBoth")
},_refreshLoading:function(t){var l=this,a=l.data("dir"),i=l.data("pullDirection"),r=l._getCurObj();return"pullUp"==t&&(("up"==a||"pullUpBoth"==i)&&r.el.removeClass("ui-refresh-flip"),("down"==a||"pullDownBoth"==i)&&r.el.removeClass("ui-refresh-flip-origin")),r.el.addClass("ui-refresh-loading"),!(e.os.ios&&"pullUp"==t)&&r.pullUpIcon.show(),r.pullUpLabel.html(l.data("loadingText")),l},_refreshAfterLoading:function(t){var l=this,a="pullup"==l.data("type")?"pullUp":"click",i=l._getCurObj();i.el.removeClass("ui-refresh-loading"),(!e.os.ios||"click"==t&&"click"==a)&&i.pullUpIcon.hide(),i.pullUpLabel.html(l.data(a+"Text"))
},_refreshAction:function(e){var t=this;"click"==e&&t._refreshLoading("click"),t.data("onReady").call(this,function(){t.afterDataLoading(e)},e),t._isOk=!1},afterDataLoading:function(e){var t=this;t._refreshAfterLoading(e),t.data("iscroll").options.topOffset=t.data("topOffset"),t._scrollRefresh(),t.setStatus(!0)},_getCurObj:function(e){var t=this,l=e||t.data("pullDirection");return t.data("pullDownBoth"==l?"elObj2":"elObj")},_scrollRefresh:function(){var e=this;e._myScroll.refresh()},setStatus:function(e){var t=this;
return t._isOk=!!e,t},hide:function(e){var t=this,l=t.widget(),a=!!e;return t.setStatus(a),t.data("isShow")&&(t.data("isShow",!1),l.hide()),t},show:function(e){var l=this,a=l.widget(),i=e||e==t?!0:!1;return l.setStatus(i),l.data("isShow")||(l.data("isShow",!0),a.show()),l},setLoadEndText:function(t,l){var a=this,i=a.widget(),r=i.find(".ui-refresh-pullup-label"),o=a.data("click"==a.data("type")?"clickText":"pullUpText"),n=t?t:o,p=!!l;return r.html(n),e(".ui-refresh-pullup-icon",i)&&e(".ui-refresh-pullup-icon",i).hide(),a.setStatus(p),a
},_eventHandler:function(t){var l=this;switch(t.type){case"touchmove":t.preventDefault();break;case"click":if(!l._isOk)return;var a=e(t.target).hasClass("ui-refresh")?e(t.target):e(t.target).parents(".ui-refresh");"both"==l.data("dir")&&(a.prev().length?l.data("pullDirection","pullUpBoth"):l.data("pullDirection","pullDownBoth")),l._refreshAction("click")}},destroy:function(){var e=this;e.widget().off(),e.data("iscroll").destroy(),e._super()}})}(Zepto);